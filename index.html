<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tokyo Drift: Bolide Edition</title>
    <style>
        :root { --neon: #00f2ff; --nitro: #ff00ea; --brake: #ff3300; --handbrake: #ffaa00; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; user-select: none; }
        
        /* HUD & UI */
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 100; color: white; }
        #speedo { position: absolute; top: 20px; left: 20px; text-shadow: 0 0 10px var(--neon); }
        #kmh { font-size: 50px; font-style: italic; }
        #nitro-bar { width: 150px; height: 10px; background: #222; border: 1px solid #fff; margin-top: 5px; }
        #nitro-fill { height: 100%; background: var(--nitro); width: 100%; transition: 0.1s; }

        /* TOUCH CONTROLS - Pro Layout */
        .btn { 
            position: absolute; pointer-events: auto; background: rgba(0,0,0,0.6); 
            border: 2px solid #fff; border-radius: 12px; display: flex; 
            align-items: center; justify-content: center; font-size: 14px; font-weight: bold;
        }
        #gas { bottom: 30px; right: 20px; width: 90px; height: 120px; border-color: var(--neon); color: var(--neon); }
        #brake { bottom: 30px; right: 125px; width: 70px; height: 80px; border-color: var(--brake); color: var(--brake); }
        #handbrake { bottom: 30px; right: 210px; width: 60px; height: 60px; border-color: var(--handbrake); color: var(--handbrake); }
        #nitro { bottom: 150px; right: 20px; width: 90px; height: 50px; border-color: var(--nitro); color: var(--nitro); }
        #left { bottom: 30px; left: 20px; width: 80px; height: 80px; }
        #right { bottom: 30px; left: 110px; width: 80px; height: 80px; }

        #loading { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 1000; color: var(--neon); }
    </style>
</head>
<body>

<div id="loading">ENTERING TOKYO...</div>

<div id="ui">
    <div id="speedo">
        <div id="kmh">0</div><small>KM/H</small>
        <div id="nitro-bar"><div id="nitro-fill"></div></div>
    </div>

    <div id="left" class="btn">STEER L</div>
    <div id="right" class="btn">STEER R</div>
    <div id="gas" class="btn">GAS</div>
    <div id="brake" class="btn">BRAKE</div>
    <div id="nitro" class="btn">NITRO</div>
    <div id="handbrake" class="btn">H-BRAKE</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x020205, 10, 80);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// TOKYO ENVIRONMENT (Neon Buildings & Stars)
const ambient = new THREE.AmbientLight(0xffffff, 0.4); scene.add(ambient);
const nightSky = new THREE.Color(0x020205); scene.background = nightSky;

function createTokyoBuilding(x, z) {
    const h = 15 + Math.random() * 40;
    const b = new THREE.Mesh(new THREE.BoxGeometry(6, h, 6), new THREE.MeshStandardMaterial({color: 0x050505}));
    b.position.set(x, h/2, z);
    scene.add(b);
    const neon = new THREE.LineSegments(new THREE.EdgesGeometry(b.geometry), new THREE.LineBasicMaterial({color: Math.random() > 0.5 ? 0x00f2ff : 0xff00ea, transparent: true, opacity: 0.4}));
    b.add(neon);
}
for(let i=0; i<50; i++) { createTokyoBuilding(-25, -i*20); createTokyoBuilding(25, -i*20); }

// ROAD
const road = new THREE.Group(); scene.add(road);
road.add(new THREE.GridHelper(1000, 50, 0xff00ea, 0x111111));

// BUGATTI BOLIDE LOADER
let car;
const loader = new THREE.GLTFLoader();
const BOLIDE_URL = 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/Ferrari.glb'; // Temporary reliable source

function buildVisualBolide() {
    const group = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.6, 4.5), new THREE.MeshStandardMaterial({color: 0x0055ff, metalness: 0.9}));
    group.add(body);
    const wing = new THREE.Mesh(new THREE.BoxGeometry(2.4, 0.1, 0.8), new THREE.MeshStandardMaterial({color: 0x000000}));
    wing.position.set(0, 0.6, 1.8);
    group.add(wing);
    return group;
}

loader.load(BOLIDE_URL, (gltf) => {
    car = gltf.scene; car.scale.set(1.6, 1.6, 1.6); car.rotation.y = Math.PI;
    scene.add(car); document.getElementById('loading').style.display = 'none';
}, undefined, (e) => {
    car = buildVisualBolide(); scene.add(car); document.getElementById('loading').style.display = 'none';
});

// GAME LOGIC
let speed = 0, nitro = 100, driftFactor = 0;
const input = { gas: false, brake: false, left: false, right: false, nitro: false, handbrake: false };

const setupBtn = (id, key) => {
    const el = document.getElementById(id);
    const start = (e) => { e.preventDefault(); input[key] = true; };
    const end = (e) => { e.preventDefault(); input[key] = false; };
    el.addEventListener('touchstart', start); el.addEventListener('touchend', end);
    el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
};
['gas','brake','left','right','nitro','handbrake'].forEach(k => setupBtn(k, k));

function animate() {
    requestAnimationFrame(animate);
    if(car) {
        // Physics logic
        if(input.gas) speed += (input.nitro && nitro > 0 ? 0.05 : 0.02);
        if(input.brake) speed *= 0.85;
        if(input.handbrake) { speed *= 0.95; driftFactor = 0.5; } else { driftFactor = 0.3; }
        if(!input.gas && !input.brake) speed *= 0.98;
        
        if(input.left) car.position.x -= speed * driftFactor;
        if(input.right) car.position.x += speed * driftFactor;

        // Nitro Use
        if(input.nitro && nitro > 0) { nitro -= 0.8; camera.fov = 85; } 
        else { camera.fov = 75; if(nitro < 100) nitro += 0.1; }
        camera.updateProjectionMatrix();

        road.position.z += speed * 25;
        if(road.position.z > 20) road.position.z = 0;

        document.getElementById('kmh').innerText = Math.floor(speed * 180);
        document.getElementById('nitro-fill').style.width = nitro + "%";
        
        camera.position.set(car.position.x, 2.5, car.position.z + 8);
        camera.lookAt(car.position.x, 1, car.position.z - 5);
    }
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
